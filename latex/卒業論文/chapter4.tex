\chapter{提案手法}\label{method}
本節では, 本研究で提案する手法について説明する. 本研究では, リクエストの割り当てと訪問順を局所探索法を用いて求める. それぞれの反復で得られたルートに対しては, LPソルバーを使って最適なサービス開始時刻を決定するアルゴリズムを提案する.
本研究では制約と目的関数が全て線形の式で表すことが可能であるため,サービス時刻を決定する問題は線形計画問題(linear programming problem, LP)として定式化し,解くことが可能である.
\section{初期解生成}
リクエストをランダムに選び, 車両$k$にリクエストのペアが連続となるようにルートの最後に挿入する. これを$k = 1 から m$まで繰り返した後, 未割り当てのリクエストがあれば$k = 1 $として同様の操作を続ける. これを未割り当てのリクエストがなくなるまで続ける.

\section{制限の緩和}
本研究では, 局所探索を行う上でより自由に探索を行うために, 車両における容量制約を緩和し, 容量制約を破った時のペナルティを計算するペナルティ関数を定義する. 容量制約のペナルティ関数を目的関数に加えた評価関数を用いて解を評価することにより, 実行不可能解も探索可能になる.

車両の容量制約のペナルティは, 車両の最大容量を超えて乗った人数として, $QP$と表す. 車両$k$に対してルートの$i$番目を訪問後に容量を超えて乗っている人数を$QP_i^k$とすると,
\begin{align*}
  QP = \sum_{k \in K}\sum_{i \in n_k} QP_i^k,
\end{align*}
と表せる．
$\gamma$を定数とすると、ペナルティを加えた評価関数を$f(\sigma)$とすると
\begin{align*}
  f(\sigma) = \alpha d(\sigma)+ \beta t(\sigma) + \gamma QP,
\end{align*}
で定義する.

\section{局所探索法}
局所探索法(local search)とは、解を逐次的に改善させていく手法である。解に変化を少し加える操作を近傍操作と呼び、近傍操作によって生成されうる解の集合を近傍と呼ぶ。局所探索法では、適当な初期解からはじめ、現在の解の近傍内に、より良い解が存在すればその解に移動する、という操作を近傍内に改善がなくなるまで反復する方法である。本研究では、近傍操作は大きく分けてルート内の操作とルート間の操作の2種類を用いる。

\subsection{ルート内の近傍操作}
1つのルートの1つの頂点を選び、同じルート内の別の箇所に挿入し直す操作である。本研究では1つのルートで改善がなくなるまでルート内の近傍操作を行うが、探索する近傍サイズはルート内の頂点数を$a$とすると$a^2$とした。

\subsection{ルート間の近傍操作}
1つのルートから1つのリクエストペアを選び、別のルートに挿入する操作である。挿入する場所は評価関数が最も良くなる場所とする。ルート間の近傍操作を行い、現在の解の評価関数よりも改善した場合、操作後の近傍解に移動する。
本研究では、リクエストペアを選ぶルートの選択方法に対して、
\begin{enumerate}
 \item 完全にランダムに選択する場合
 \item ルートごとの時間枠と乗車時間ペナルティの和の最大のルートから最小のルートに挿入
\end{enumerate}
の2種類の方法を実装し、計算結果を比較する。
\subsection{局所探索アルゴリズム}
時間枠及び乗車時間ペナルティ付き乗合タクシー問題に対する局所探索アルゴリズムとして、まずルート内で近傍操作を改善がなくなるまで行い、得られた局所最適解に対してルート間の近傍操作を行い、最良の箇所に挿入する。改善している場合、局所最適解を更新し、現在の解から移動する。

以下に、車両数を$m$、それぞれの車両$j$のルートにある頂点の数を$a_j$、$x_{init}$を初期解、$x$を現在解、$x_{init}$を暫定解とした際の提案手法の概要を示す。
\begin{algorithm}
 \caption{提案手法}
 \label{algo1}
 \begin{algorithmic}[1]%1を0にすると行番号なし．
  \STATE $x := x_{init}$とする。
  \FOR{$j = 1$ to $m$}
  \FOR{$k = 1$ to $a_j^2$}
  \STATE ルート内の近傍操作を行う
  \IF{改善した}
  \STATE  $x_{best} := x$
  \ENDIF
  \ENDFOR
  \ENDFOR
  \STATE ルート間の近傍操作を行う
  \STATE 変化があったルートに対してルート内の近傍操作を行う
  \IF{改善した}
  \STATE  $x_{best} := x$
  \ENDIF
  \STATE $x_{best}$を局所最適解として出力して終了．
 \end{algorithmic}
\end{algorithm}
